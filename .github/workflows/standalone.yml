name: "Standalone"

on: [push]

jobs:
  execute:
    name: "Supported OS / Build, Test and Run"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        operative-system: [ubuntu-22.04, ubuntu-20.04, ubuntu-18.04]
        environments: [Debug, Release]
    steps:
      - uses: actions/checkout@v3
      -
        name: Dependencies
        run: |
          sudo apt update 
          sudo apt install build-essential
      - name: Install boost
        id: install-boost
        uses: MarkusJx/install-boost@v2.3.0
        env:
          BUILD_TYPE: ${{ matrix.environments }}
        with:
          boost_version: 1.79.0
      -
        name: Build, Test and Run
        env:
          APP_ENV: ${{ matrix.environments }}
          APP_PORT: 5000
          BOOST_ROOT: ${{ steps.install-boost.outputs.BOOST_ROOT }}
        run: |
          cd source
          sudo cmake -S . -B . \
            -DCMAKE_BUILD_TYPE=${{ matrix.environments }} \
            -DBoost_INCLUDE_DIR=${{steps.install-boost.outputs.BOOST_ROOT}}/include \
            -DBoost_LIBRARY_DIRS=${{steps.install-boost.outputs.BOOST_ROOT}}/lib
          sudo cmake --install . --strip
          sudo cmake --build . --config ${{ matrix.environments }}
          ./Test
          ./Core
      -
        name: Digest
        run: echo "${{ github.sha }}"
      -
        name: Zip Binary
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: montudor/action-zip@v1
        with:
          args: zip -qq -r ${{ github.ref_name }}-${{ matrix.environments }}.zip source/Core
      - name: Upload Binary
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GH_API_TOKEN }}
          file: ${{ github.ref_name }}-${{ matrix.environments }}.zip
          asset_name: "${{ github.ref_name }}—${{ matrix.environments }}—${{matrix.operative-system}}.zip"
          tag: ${{ github.ref }}
          overwrite: true
